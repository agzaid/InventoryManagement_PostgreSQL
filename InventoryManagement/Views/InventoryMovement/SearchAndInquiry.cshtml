@{
    ViewData["Title"] = "البحث والاستعلام";
}

<style>
    .tab-active {
        background-color: #1e40af !important;
        color: white !important;
        box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
    }

    .custom-scrollbar::-webkit-scrollbar {
        width: 5px;
    }

    .custom-scrollbar::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 10px;
    }
</style>

<main class="flex-1 overflow-hidden flex flex-col" dir="rtl">

    <div class="flex flex-col md:flex-row items-center justify-between gap-4 mb-6">
        <div>
            <h2 id="pageTitle" class="text-2xl font-bold text-slate-900 dark:text-white flex items-center gap-2">
                <span class="material-icons-outlined text-blue-600">search</span>
                البحث والاستعلام
            </h2>
            <p class="text-slate-500 dark:text-slate-400 text-sm mt-1">استعلام عن حركات المخزون حسب الفترة الزمنية</p>
        </div>

        <div class="flex bg-slate-200 dark:bg-slate-700 p-1 rounded-xl shadow-inner">
            <button type="button" onclick="toggleMode('entry')" id="btn-entry" class="tab-btn tab-active px-6 py-2 rounded-lg text-sm font-bold transition-all flex items-center gap-2">
                <span class="material-icons-outlined text-sm">download</span> الوارد
            </button>
            <button type="button" onclick="toggleMode('outgoing')" id="btn-outgoing" class="tab-btn px-6 py-2 rounded-lg text-sm font-bold text-slate-600 dark:text-slate-300 transition-all flex items-center gap-2">
                <span class="material-icons-outlined text-sm">upload</span> المنصرف
            </button>
            <button type="button" onclick="toggleMode('transfer')" id="btn-transfer" class="tab-btn px-6 py-2 rounded-lg text-sm font-bold text-slate-600 dark:text-slate-300 transition-all flex items-center gap-2">
                <span class="material-icons-outlined text-sm">compare_arrows</span> التحويل
            </button>
            <button type="button" onclick="toggleMode('returned')" id="btn-returned" class="tab-btn px-6 py-2 rounded-lg text-sm font-bold text-slate-600 dark:text-slate-300 transition-all flex items-center gap-2">
                <span class="material-icons-outlined text-sm">assignment_return</span> المرتجع
            </button>
        </div>
    </div>

    <!-- Entry (الوارد) Section -->
    <div id="entrySection" class="flex flex-col gap-4 animate-fadeIn">
        <!-- Date Range Filter -->
        <div class="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 p-5">
            <div class="flex flex-wrap items-end gap-4">
                <div class="space-y-1.5">
                    <label class="block text-xs font-semibold text-slate-500 uppercase">من تاريخ</label>
                    <input type="date" id="entryDateFrom" class="w-full bg-slate-50 dark:bg-slate-900 border border-slate-300 dark:border-slate-600 rounded-lg px-4 py-2 text-sm dark:text-white">
                </div>
                <div class="space-y-1.5">
                    <label class="block text-xs font-semibold text-slate-500 uppercase">إلى تاريخ</label>
                    <input type="date" id="entryDateTo" class="w-full bg-slate-50 dark:bg-slate-900 border border-slate-300 dark:border-slate-600 rounded-lg px-4 py-2 text-sm dark:text-white">
                </div>
                <button type="button" onclick="searchTransactions('entry')" class="flex items-center gap-2 px-6 py-2 bg-blue-800 hover:bg-blue-900 text-white rounded-lg shadow-md transition-all text-sm font-medium">
                    <span class="material-icons-outlined text-lg">search</span> بحث
                </button>
                <button type="button" onclick="printReport('entry')" class="flex items-center gap-2 px-4 py-2 bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-600 rounded-lg text-slate-700 dark:text-slate-200 hover:bg-slate-50 transition-all text-sm font-medium">
                    <span class="material-icons-outlined text-lg">print</span> طباعة
                </button>
            </div>
        </div>

        <!-- Results Table -->
        <div class="bg-white dark:bg-slate-800 rounded-xl border border-slate-200 dark:border-slate-700 flex-1 overflow-hidden flex flex-col">
            <div class="p-4 bg-green-50 dark:bg-green-900/20 border-b border-slate-200 dark:border-slate-700">
                <h3 class="font-bold text-green-800 dark:text-green-400 flex items-center gap-2">
                    <span class="material-icons-outlined">download</span> تقرير الوارد إلى المخزن
                </h3>
            </div>
            <div class="flex-1 overflow-auto custom-scrollbar">
                <table class="w-full text-right text-sm" id="entryTable">
                    <thead class="bg-slate-50 dark:bg-slate-900 sticky top-0 text-xs text-slate-500">
                        <tr>
                            <th class="p-3 border-b">رقم المعاملة</th>
                            <th class="p-3 border-b">كود المورد</th>
                            <th class="p-3 border-b">اسم المورد</th>
                            <th class="p-3 border-b">كود الصنف</th>
                            <th class="p-3 border-b">اسم الصنف</th>
                            <th class="p-3 border-b">الكمية</th>
                            <th class="p-3 border-b">السعر</th>
                            <th class="p-3 border-b">التاريخ</th>
                        </tr>
                    </thead>
                    <tbody id="entryTableBody">
                        @if (ViewBag.Transactions != null)
                        {
                            foreach (var tr in ViewBag.Transactions)
                            {
                                <tr class="border-b dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-800/50" data-date="@tr.TrDate2">
                                    <td class="p-3 font-mono font-bold text-blue-600">@tr.TrNum</td>
                                    <td class="p-3">@tr.SupplierCode</td>
                                    <td class="p-3">@tr.SupplierDesc</td>
                                    <td class="p-3 font-mono">@tr.ItemCode</td>
                                    <td class="p-3">@tr.ItemDesc</td>
                                    <td class="p-3">@tr.ItemQnt</td>
                                    <td class="p-3">@tr.ItemPrice</td>
                                    <td class="p-3">@tr.TrDate2</td>
                                </tr>
                            }
                        }
                        else
                        {
                            <tr>
                                <td colspan="8" class="p-10 text-center text-slate-400">
                                    <span class="material-icons-outlined text-4xl block mb-2">find_in_page</span>
                                    لا توجد نتائج - اختر الفترة الزمنية واضغط بحث
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
            <div class="p-4 border-t border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-900/50 flex items-center justify-between">
                <span class="text-xs text-slate-500" id="paginationInfo-entry">إظهار 0 من 0 سجل</span>
                <div class="flex gap-2" id="paginationControls-entry">
                </div>
            </div>
        </div>
    </div>
    <!-- Outgoing (المنصرف) Section -->
    <div id="outgoingSection" class="hidden flex flex-col gap-4 animate-fadeIn">
        <!-- Date Range Filter -->
        <div class="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 p-5">
            <div class="flex flex-wrap items-end gap-4">
                <div class="space-y-1.5">
                    <label class="block text-xs font-semibold text-slate-500 uppercase">من تاريخ</label>
                    <input type="date" id="outgoingDateFrom" class="w-full bg-slate-50 dark:bg-slate-900 border border-slate-300 dark:border-slate-600 rounded-lg px-4 py-2 text-sm dark:text-white">
                </div>
                <div class="space-y-1.5">
                    <label class="block text-xs font-semibold text-slate-500 uppercase">إلى تاريخ</label>
                    <input type="date" id="outgoingDateTo" class="w-full bg-slate-50 dark:bg-slate-900 border border-slate-300 dark:border-slate-600 rounded-lg px-4 py-2 text-sm dark:text-white">
                </div>
                <button type="button" onclick="searchTransactions('outgoing')" class="flex items-center gap-2 px-6 py-2 bg-blue-800 hover:bg-blue-900 text-white rounded-lg shadow-md transition-all text-sm font-medium">
                    <span class="material-icons-outlined text-lg">search</span> بحث
                </button>
                <button type="button" onclick="printReport('outgoing')" class="flex items-center gap-2 px-4 py-2 bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-600 rounded-lg text-slate-700 dark:text-slate-200 hover:bg-slate-50 transition-all text-sm font-medium">
                    <span class="material-icons-outlined text-lg">print</span> طباعة
                </button>
            </div>
        </div>

        <!-- Results Table -->
        <div class="bg-white dark:bg-slate-800 rounded-xl border border-slate-200 dark:border-slate-700 flex-1 overflow-hidden flex flex-col">
            <div class="p-4 bg-red-50 dark:bg-red-900/20 border-b border-slate-200 dark:border-slate-700">
                <h3 class="font-bold text-red-800 dark:text-red-400 flex items-center gap-2">
                    <span class="material-icons-outlined">upload</span> تقرير المنصرف من المخزن
                </h3>
            </div>
            <div class="flex-1 overflow-auto custom-scrollbar">
                <table class="w-full text-right text-sm" id="outgoingTable">
                    <thead class="bg-slate-50 dark:bg-slate-900 sticky top-0 text-xs text-slate-500">
                        <tr>
                            <th class="p-3 border-b">رقم المعاملة</th>
                            <th class="p-3 border-b">كود الصنف</th>
                            <th class="p-3 border-b">اسم الصنف</th>
                            <th class="p-3 border-b">الكمية</th>
                            <th class="p-3 border-b">الإدارة</th>
                            <th class="p-3 border-b">الموظف</th>
                            <th class="p-3 border-b">التاريخ</th>
                        </tr>
                    </thead>
                    <tbody id="outgoingTableBody">
                        @if (ViewBag.Transactions != null)
                        {
                            foreach (var tr in ViewBag.Transactions)
                            {
                                <tr class="border-b dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-800/50" data-date="@tr.TrDate2">
                                    <td class="p-3 font-mono font-bold text-blue-600">@tr.TrNum</td>
                                    <td class="p-3 font-mono">@tr.ItemCode</td>
                                    <td class="p-3">@tr.ItemDesc</td>
                                    <td class="p-3">@tr.ItemQnt</td>
                                    <td class="p-3">@tr.DepDesc</td>
                                    <td class="p-3">@tr.EmpName</td>
                                    <td class="p-3">@tr.TrDate2</td>
                                </tr>
                            }
                        }
                        else
                        {
                            <tr>
                                <td colspan="7" class="p-10 text-center text-slate-400">
                                    <span class="material-icons-outlined text-4xl block mb-2">find_in_page</span>
                                    لا توجد نتائج - اختر الفترة الزمنية واضغط بحث
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
            <div class="p-4 border-t border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-900/50 flex items-center justify-between">
                <span class="text-xs text-slate-500" id="paginationInfo-entry">إظهار 0 من 0 سجل</span>
                <div class="flex gap-2" id="paginationControls-entry">
                </div>
            </div>
        </div>
    </div>
    <!-- Transfer (التحويل) Section -->
    <div id="querySection" class="hidden flex flex-col gap-4 animate-fadeIn">
        <!-- Date Range Filter -->
        <div class="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 p-5">
            <div class="flex flex-wrap items-end gap-4">
                <div class="space-y-1.5">
                    <label class="block text-xs font-semibold text-slate-500 uppercase">من تاريخ</label>
                    <input type="date" id="transferDateFrom" class="w-full bg-slate-50 dark:bg-slate-900 border border-slate-300 dark:border-slate-600 rounded-lg px-4 py-2 text-sm dark:text-white">
                </div>
                <div class="space-y-1.5">
                    <label class="block text-xs font-semibold text-slate-500 uppercase">إلى تاريخ</label>
                    <input type="date" id="transferDateTo" class="w-full bg-slate-50 dark:bg-slate-900 border border-slate-300 dark:border-slate-600 rounded-lg px-4 py-2 text-sm dark:text-white">
                </div>
                <button type="button" onclick="searchTransactions('transfer')" class="flex items-center gap-2 px-6 py-2 bg-blue-800 hover:bg-blue-900 text-white rounded-lg shadow-md transition-all text-sm font-medium">
                    <span class="material-icons-outlined text-lg">search</span> بحث
                </button>
                <button type="button" onclick="printReport('transfer')" class="flex items-center gap-2 px-4 py-2 bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-600 rounded-lg text-slate-700 dark:text-slate-200 hover:bg-slate-50 transition-all text-sm font-medium">
                    <span class="material-icons-outlined text-lg">print</span> طباعة
                </button>
            </div>
        </div>

        <!-- Results Table -->
        <div class="bg-white dark:bg-slate-800 rounded-xl border border-slate-200 dark:border-slate-700 flex-1 overflow-hidden flex flex-col">
            <div class="p-4 bg-blue-50 dark:bg-blue-900/20 border-b border-slate-200 dark:border-slate-700">
                <h3 class="font-bold text-blue-800 dark:text-blue-400 flex items-center gap-2">
                    <span class="material-icons-outlined">compare_arrows</span> تقرير التحويلات بين المخازن
                </h3>
            </div>
            <div class="flex-1 overflow-auto custom-scrollbar">
                <table class="w-full text-right text-sm" id="transferTable">
                    <thead class="bg-slate-50 dark:bg-slate-900 sticky top-0 text-xs text-slate-500">
                        <tr>
                            <th class="p-3 border-b">رقم المعاملة</th>
                            <th class="p-3 border-b">كود الصنف</th>
                            <th class="p-3 border-b">اسم الصنف</th>
                            <th class="p-3 border-b">الكمية</th>
                            <th class="p-3 border-b">من مخزن</th>
                            <th class="p-3 border-b">إلى مخزن</th>
                            <th class="p-3 border-b">التاريخ</th>
                        </tr>
                    </thead>
                    <tbody id="transferTableBody">
                        @if (ViewBag.Transactions != null)
                        {
                            foreach (var tr in ViewBag.Transactions)
                            {
                                <tr class="border-b dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-800/50" data-date="@tr.TrDate2">
                                    <td class="p-3 font-mono font-bold text-blue-600">@tr.TrNum</td>
                                    <td class="p-3 font-mono">@tr.ItemCode</td>
                                    <td class="p-3">@tr.ItemDesc</td>
                                    <td class="p-3">@tr.ItemQnt</td>
                                    <td class="p-3">المخزن الرئيسي</td>
                                    <td class="p-3">@tr.DepDesc</td>
                                    <td class="p-3">@tr.TrDate2</td>
                                </tr>
                            }
                        }
                        else
                        {
                            <tr>
                                <td colspan="7" class="p-10 text-center text-slate-400">
                                    <span class="material-icons-outlined text-4xl block mb-2">find_in_page</span>
                                    لا توجد نتائج - اختر الفترة الزمنية واضغط بحث
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
            <div class="p-4 border-t border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-900/50 flex items-center justify-between">
                <span class="text-xs text-slate-500" id="paginationInfo-entry">إظهار 0 من 0 سجل</span>
                <div class="flex gap-2" id="paginationControls-entry">
                </div>
            </div>
        </div>

    </div>

    <!-- Returned (المرتجع) Section -->
    <div id="returnedSection" class="hidden flex flex-col gap-4 animate-fadeIn">
        <!-- Date Range Filter -->
        <div class="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 p-5">
            <div class="flex flex-wrap items-end gap-4">
                <div class="space-y-1.5">
                    <label class="block text-xs font-semibold text-slate-500 uppercase">من تاريخ</label>
                    <input type="date" id="returnedDateFrom" class="w-full bg-slate-50 dark:bg-slate-900 border border-slate-300 dark:border-slate-600 rounded-lg px-4 py-2 text-sm dark:text-white">
                </div>
                <div class="space-y-1.5">
                    <label class="block text-xs font-semibold text-slate-500 uppercase">إلى تاريخ</label>
                    <input type="date" id="returnedDateTo" class="w-full bg-slate-50 dark:bg-slate-900 border border-slate-300 dark:border-slate-600 rounded-lg px-4 py-2 text-sm dark:text-white">
                </div>
                <button type="button" onclick="searchTransactions('returned')" class="flex items-center gap-2 px-6 py-2 bg-blue-800 hover:bg-blue-900 text-white rounded-lg shadow-md transition-all text-sm font-medium">
                    <span class="material-icons-outlined text-lg">search</span> بحث
                </button>
                <button type="button" onclick="printReport('returned')" class="flex items-center gap-2 px-4 py-2 bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-600 rounded-lg text-slate-700 dark:text-slate-200 hover:bg-slate-50 transition-all text-sm font-medium">
                    <span class="material-icons-outlined text-lg">print</span> طباعة
                </button>
            </div>
        </div>

        <!-- Results Table -->
        <div class="bg-white dark:bg-slate-800 rounded-xl border border-slate-200 dark:border-slate-700 flex-1 overflow-hidden flex flex-col">
            <div class="p-4 bg-orange-50 dark:bg-orange-900/20 border-b border-slate-200 dark:border-slate-700">
                <h3 class="font-bold text-orange-800 dark:text-orange-400 flex items-center gap-2">
                    <span class="material-icons-outlined">assignment_return</span> تقرير المرتجعات
                </h3>
            </div>
            <div class="flex-1 overflow-auto custom-scrollbar">
                <table class="w-full text-right text-sm" id="returnedTable">
                    <thead class="bg-slate-50 dark:bg-slate-900 sticky top-0 text-xs text-slate-500">
                        <tr>
                            <th class="p-3 border-b">رقم المعاملة</th>
                            <th class="p-3 border-b">كود الصنف</th>
                            <th class="p-3 border-b">اسم الصنف</th>
                            <th class="p-3 border-b">الكمية</th>
                            <th class="p-3 border-b">سبب الإرجاع</th>
                            <th class="p-3 border-b">التاريخ</th>
                        </tr>
                    </thead>
                    <tbody id="returnedTableBody">
                        @if (ViewBag.Transactions != null)
                        {
                            foreach (var tr in ViewBag.Transactions)
                            {
                                <tr class="border-b dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-800/50" data-date="@tr.TrDate2">
                                    <td class="p-3 font-mono font-bold text-blue-600">@tr.TrNum</td>
                                    <td class="p-3 font-mono">@tr.ItemCode</td>
                                    <td class="p-3">@tr.ItemDesc</td>
                                    <td class="p-3">@tr.ItemQnt</td>
                                    <td class="p-3">@tr.DepDesc</td>
                                    <td class="p-3">@tr.TrDate2</td>
                                </tr>
                            }
                        }
                        else
                        {
                            <tr>
                                <td colspan="6" class="p-10 text-center text-slate-400">
                                    <span class="material-icons-outlined text-4xl block mb-2">find_in_page</span>
                                    لا توجد نتائج - اختر الفترة الزمنية واضغط بحث
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
            <div class="p-4 border-t border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-900/50 flex items-center justify-between">
                <span class="text-xs text-slate-500" id="paginationInfo-entry">إظهار 0 من 0 سجل</span>
                <div class="flex gap-2" id="paginationControls-entry">
                </div>
            </div>
        </div>
    </div>
</main>
@section Scripts {
    <script>
        // ============================================
        // CONSTANTS & GLOBAL STATE
        // ============================================
        let currentPages = { entry: 1, outgoing: 1, transfer: 1, returned: 1 };
        const PAGE_SIZE = 20;

        // ============================================
        // ALL FUNCTION DEFINITIONS
        // ============================================

        window.toggleMode = function(mode) {
            $('#entrySection, #outgoingSection, #querySection, #returnedSection').addClass('hidden');

            $('.tab-btn').removeClass('tab-active bg-emerald-50 text-emerald-700 shadow-sm ring-1 ring-emerald-200')
                         .addClass('text-slate-600 dark:text-slate-300 opacity-60 bg-transparent')
                         .css('border-bottom', '3px solid transparent');

            const sectionMap = {
                'entry': { section: '#entrySection', btn: '#btn-entry' },
                'outgoing': { section: '#outgoingSection', btn: '#btn-outgoing' },
                'transfer': { section: '#querySection', btn: '#btn-transfer' },
                'returned': { section: '#returnedSection', btn: '#btn-returned' }
            };

            const target = sectionMap[mode];
            if (target) {
                $(target.section).removeClass('hidden').hide().fadeIn(400);
                $(target.btn).addClass('tab-active bg-emerald-50 text-emerald-700')
                            .removeClass('text-slate-600 opacity-60')
                            .css('border-bottom', '3px solid #10b981');

                // Don't call searchTransactions here yet — let document.ready handle it
            }
        };

        window.searchTransactions = function(mode, page = 1) {
            currentPages[mode] = page;

            const types = { 'entry': 1, 'outgoing': 2, 'transfer': '3,4', 'returned': '5,6' };
            const trType = types[mode];
            const tableBodyId = `#${mode}TableBody`;
            const dateFrom = $(`#${mode}DateFrom`).val();
            const dateTo = $(`#${mode}DateTo`).val();

            // Validate dates - using _AlertHelper directly (guaranteed to be loaded)
            if (!dateFrom || !dateTo) {
                _AlertHelper.showWarning("يرجى تحديد تاريخ البداية والنهاية");
                return;
            }

            if (new Date(dateFrom) > new Date(dateTo)) {
                _AlertHelper.showWarning("تاريخ البداية يجب أن يكون قبل تاريخ النهاية");
                return;
            }

            $(tableBodyId).html('<tr><td colspan="10" class="p-10 text-center text-blue-500">جاري التحميل...</td></tr>');

            const culture = window.location.pathname.split('/')[1] || 'en';

            $.ajax({
                url: `/${culture}/InventoryMovement/GetTransactionsData`,
                type: 'GET',
                data: { trType, fromDate: dateFrom, toDate: dateTo, page, pageSize: PAGE_SIZE },
                success: function(response) {
                    let html = '';
                    let items = response.items || response;
                    let totalCount = response.totalCount || (Array.isArray(items) ? items.length : 0);

                    if (items && items.length > 0) {
                        items.forEach(tr => {
                            html += `<tr id="row-tr-${tr.trNum}" class="border-b dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-800/50">
                                <td class="p-3 font-mono font-bold text-blue-600">${tr.trNum}</td>
                                ${mode === 'entry' ? `<td class="p-3">${tr.supplierCode || ''}</td>
                                                       <td class="p-3">${tr.supplierDesc || ''}</td>` : 
                                  `<td class="p-3">${tr.depDesc || ''}</td>`}
                                <td class="p-3 font-mono">${tr.itemCode}</td>
                                <td class="p-3">${tr.itemDesc || ''}</td>
                                <td class="p-3 text-center">${tr.itemQnt}</td>
                                ${mode === 'entry' ? `<td class="p-3">${tr.itemPrice || ''}</td>` : ''}
                                <td class="p-3">${tr.trDate2 || ''}</td>
                            </tr>`;
                        });
                        renderPagination(mode, page, totalCount, PAGE_SIZE);
                    } else {
                        html = '<tr><td colspan="10" class="p-10 text-center text-slate-400">لا توجد سجلات</td></tr>';
                    }
                    $(tableBodyId).html(html);
                },
                error: function(xhr, status, error) {
                    console.error('AJAX Error:', error);
                    _AlertHelper.showError("حدث خطأ في الاتصال بالخادم");
                    $(tableBodyId).html('<tr><td colspan="10" class="p-10 text-center text-red-500">خطأ في التحميل</td></tr>');
                }
            });
        };

        window.deleteTransaction = function(trNum) {
            _AlertHelper.showConfirm("حذف", "هل أنت متأكد؟", "نعم، احذف").then(res => {
                if (res.isConfirmed) {
                    $(`#row-tr-${trNum}`).fadeOut();
                }
            });
        };

        window.printReport = function(mode) {
            const tableId = `#${mode}Table`;
            const printWindow = window.open('', '', 'height=600,width=800');
            printWindow.document.write('<html><head><title>تقرير</title>');
            printWindow.document.write('<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tailwindcss@latest/tailwind.min.css">');
            printWindow.document.write('</head><body dir="rtl">');
            printWindow.document.write($(tableId).html());
            printWindow.document.write('</body></html>');
            printWindow.document.close();
            printWindow.print();
        };

        function renderPagination(mode, currentPage, totalCount, pageSize) {
            const totalPages = Math.ceil(totalCount / pageSize);
            let html = '';
            if (totalPages <= 1) {
                $(`#paginationControls-${mode}`).empty();
                return;
            }

            html += `<button onclick="window.searchTransactions('${mode}', ${Math.max(1, currentPage - 1)})" ${currentPage === 1 ? 'disabled' : ''} class="px-3 py-1 border rounded hover:bg-gray-100 disabled:opacity-50">السابق</button>`;
            html += `<span class="px-4 text-sm">صفحة ${currentPage} من ${totalPages}</span>`;
            html += `<button onclick="window.searchTransactions('${mode}', ${Math.min(totalPages, currentPage + 1)})" ${currentPage === totalPages ? 'disabled' : ''} class="px-3 py-1 border rounded hover:bg-gray-100 disabled:opacity-50">التالي</button>`;

            $(`#paginationControls-${mode}`).html(html);
            $(`#paginationInfo-${mode}`).text(`إظهار ${(currentPage - 1) * pageSize + 1} إلى ${Math.min(currentPage * pageSize, totalCount)} من ${totalCount} سجل`);
        }

        $(document).ready(function() {
            const today = new Date().toISOString().split('T')[0];
            const lastMonth = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];

            // 1. Set date values first
            ['entry', 'outgoing', 'transfer', 'returned'].forEach(m => {
                $(`#${m}DateFrom`).val(lastMonth);
                $(`#${m}DateTo`).val(today);
            });

            window.toggleMode('entry');

            window.searchTransactions('entry', 1);
        });
    </script>
}
