@model Application.Interfaces.Models.CurrentStockDto
@{
    ViewData["Title"] = "الأرصدة الحالية";
}

@* 1. Navigation Bar remains the same *@
<nav class="bg-white dark:bg-[#1f2937] border-b border-gray-200 dark:border-gray-700 sticky top-0 z-50 shadow-sm">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex justify-between h-16">
            <div class="flex items-center gap-3">
                <div class="flex-shrink-0 flex items-center gap-2">
                    <span class="material-icons-round text-blue-700 text-3xl">inventory_2</span>
                    <h1 class="text-xl font-bold text-gray-900 dark:text-white">نظام المخازن</h1>
                </div>
            </div>
            <div class="flex items-center gap-4">
               
            </div>
        </div>
    </div>
</nav>

<main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8" dir="rtl">

    @* 2. Search Section *@
    <div class="bg-white dark:bg-[#1f2937] rounded-xl shadow-lg p-6 mb-8 border border-gray-100 dark:border-gray-700">
        <div class="flex flex-col md:flex-row gap-4 items-end">
            <div class="w-full md:w-2/3">
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">بحث عن صنف</label>
                <select id="itemSelect" class="block w-full rounded-lg border-gray-300 dark:border-gray-600 focus:border-blue-700 focus:ring-blue-700 dark:bg-gray-800 dark:text-white sm:text-sm py-3">
                    <option value="">اختر الصنف...</option>
                    @if (ViewBag.Items != null)
                    {
                        foreach (var item in ViewBag.Items)
                        {
                            <option value="@item.ItemCode">@item.ItemCode - @item.ItemDesc</option>
                        }
                    }
                </select>
            </div>
            <div class="w-full md:w-1/3 flex gap-2">
                <button type="button" id="btnShowBalance" class="w-full inline-flex justify-center items-center px-4 py-3 border border-transparent shadow-sm text-sm font-medium rounded-lg text-white bg-blue-700 hover:bg-blue-800 transition-all">
                    عرض البيانات
                </button>
            </div>
        </div>
        
        <!-- Item Balance Display -->
        <div id="itemBalanceResult" class="mt-6 hidden">
            <div class="bg-gradient-to-l from-blue-600 to-blue-500 px-4 py-3 rounded-t-lg">
                <h3 class="text-white font-bold flex items-center gap-2">
                    <span class="material-icons-round">inventory</span>
                    <span id="selectedItemName">رصيد الصنف</span>
                </h3>
            </div>
            <div class="bg-gray-50 dark:bg-gray-800 p-4 rounded-b-lg border border-t-0 border-gray-200 dark:border-gray-700">
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                    <div class="text-center p-3 bg-white dark:bg-gray-900 rounded-lg shadow-sm">
                        <p class="text-xs text-gray-500 mb-1">رصيد الفتح</p>
                        <p class="text-xl font-bold text-emerald-600" id="balOpeningBalance">0</p>
                    </div>
                    <div class="text-center p-3 bg-white dark:bg-gray-900 rounded-lg shadow-sm">
                        <p class="text-xs text-gray-500 mb-1">الرصيد الحالي</p>
                        <p class="text-xl font-bold text-blue-600" id="balTotalStockBalance">0</p>
                    </div>
                    <div class="text-center p-3 bg-white dark:bg-gray-900 rounded-lg shadow-sm">
                        <p class="text-xs text-gray-500 mb-1">الوارد</p>
                        <p class="text-xl font-bold text-green-600" id="balTodayInward">0</p>
                    </div>
                    <div class="text-center p-3 bg-white dark:bg-gray-900 rounded-lg shadow-sm">
                        <p class="text-xs text-gray-500 mb-1">المنصرف</p>
                        <p class="text-xl font-bold text-red-600" id="balTodayOutward">0</p>
                    </div>
                </div>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div class="text-center p-3 bg-white dark:bg-gray-900 rounded-lg shadow-sm">
                        <p class="text-xs text-gray-500 mb-1">محول منه</p>
                        <p class="text-xl font-bold text-orange-600" id="balTodayTransFrom">0</p>
                    </div>
                    <div class="text-center p-3 bg-white dark:bg-gray-900 rounded-lg shadow-sm">
                        <p class="text-xs text-gray-500 mb-1">محول إليه</p>
                        <p class="text-xl font-bold text-blue-600" id="balTodayTransTo">0</p>
                    </div>
                    <div class="text-center p-3 bg-white dark:bg-gray-900 rounded-lg shadow-sm">
                        <p class="text-xs text-gray-500 mb-1">مرتجع وارد</p>
                        <p class="text-xl font-bold text-teal-600" id="balTodayReturnIn">0</p>
                    </div>
                    <div class="text-center p-3 bg-white dark:bg-gray-900 rounded-lg shadow-sm">
                        <p class="text-xs text-gray-500 mb-1">مرتجع منصرف</p>
                        <p class="text-xl font-bold text-rose-600" id="balTodayReturnOut">0</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    @* 3. Data Display Section (The Grid) *@
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">

        @* Right Column: Today's Movement *@
        <div class="bg-white dark:bg-[#1f2937] rounded-xl shadow-lg overflow-hidden border border-gray-100 dark:border-gray-700">
            <div class="bg-gradient-to-l from-red-600 to-red-500 px-6 py-4 flex justify-between items-center">
                <h2 class="text-lg font-bold text-white flex items-center gap-2">
                    <span class="material-icons-round">analytics</span> حركة اليوم
                </h2>
                <span class="text-red-100 text-sm bg-white/20 px-2 py-1 rounded">@DateTime.Now.ToString("dd/MM/yyyy")</span>
            </div>
            <div class="p-6">
                <div class="space-y-2">
                    @{
                        var rowStyle = "flex justify-between items-center p-2.5 rounded-lg bg-gray-50 dark:bg-gray-800/50";
                    }

                    <div class="@rowStyle">
                        <span class="text-gray-600 dark:text-gray-400 font-medium">وارد</span>
                        <span class="font-bold text-emerald-600" id="todayInward">@(Model?.TodayInward ?? 0)</span>
                    </div>
                    <div class="@rowStyle">
                        <span class="text-gray-600 dark:text-gray-400 font-medium">منصرف</span>
                        <span class="font-bold text-red-600" id="todayOutward">@(Model?.TodayOutward ?? 0)</span>
                    </div>
                    <div class="@rowStyle">
                        <span class="text-gray-600 dark:text-gray-400 font-medium">محول منه</span>
                        <span class="font-bold text-orange-600" id="todayTransFrom">@(Model?.TodayTransFrom ?? 0)</span>
                    </div>
                    <div class="@rowStyle">
                        <span class="text-gray-600 dark:text-gray-400 font-medium">محول إليه</span>
                        <span class="font-bold text-blue-600" id="todayTransTo">@(Model?.TodayTransTo ?? 0)</span>
                    </div>
                    <div class="@rowStyle">
                        <span class="text-gray-600 dark:text-gray-400 font-medium">مرتجع وارد</span>
                        <span class="font-bold text-teal-600" id="todayReturnIn">@(Model?.TodayReturnIn ?? 0)</span>
                    </div>
                    <div class="@rowStyle">
                        <span class="text-gray-600 dark:text-gray-400 font-medium">مرتجع منصرف</span>
                        <span class="font-bold text-rose-600" id="todayReturnOut">@(Model?.TodayReturnOut ?? 0)</span>
                    </div>
                    <div class="@rowStyle">
                        <span class="text-gray-600 dark:text-gray-400 font-medium">أصناف راكدة</span>
                        <span class="font-bold text-slate-500" id="todayStagnant">@(Model?.TodayStagnant ?? 0)</span>
                    </div>

                    <div class="mt-4 pt-4 border-t-2 border-dashed border-gray-200 dark:border-gray-700 flex justify-between items-center">
                        <span class="text-lg font-black text-gray-800 dark:text-white">رصيد اليوم</span>
                        <div class="bg-blue-50 dark:bg-blue-900/30 px-4 py-1 rounded-lg border border-blue-100 dark:border-blue-800">
                            <span class="text-2xl font-black text-blue-700 dark:text-blue-400" id="todayBalance">@(Model?.TodayBalance ?? 0)</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        @* Left Column: Previous Balance *@
        <div class="bg-white dark:bg-[#1f2937] rounded-xl shadow-lg overflow-hidden border border-gray-100 dark:border-gray-700">
            <div class="bg-gray-100 dark:bg-gray-800 px-6 py-4 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center">
                <h2 class="text-lg font-bold text-gray-800 dark:text-white flex items-center gap-2">
                    <span class="material-icons-round text-gray-500">history</span> رصيد يوم سابق
                </h2>
                <span class="text-gray-500 text-sm">@DateTime.Now.AddDays(-1).ToString("dd/MM/yyyy")</span>
            </div>
            <div class="p-6">
                <div class="space-y-4">
                    <div class="bg-emerald-50 dark:bg-emerald-900/20 p-4 rounded-xl border border-emerald-100 dark:border-emerald-800 flex justify-between items-center">
                        <div>
                            <p class="text-xs text-emerald-600 dark:text-emerald-400 font-bold uppercase">رصيد الفتح</p>
                            <p class="text-3xl font-black text-emerald-700 dark:text-emerald-300">@(Model?.OpeningBalance ?? 0)</p>
                        </div>
                        <span class="material-icons-round text-4xl text-emerald-200 dark:text-emerald-800">start</span>
                    </div>

                    <div id="prevBalanceSection" class="space-y-4">
                        <div class="grid grid-cols-2 gap-3">
                            <div class="p-3 bg-gray-50 dark:bg-gray-800/50 rounded-lg border-r-4 border-emerald-500">
                                <p class="text-[10px] text-gray-500 font-bold">وارد</p>
                                <p class="text-lg font-bold dark:text-white">@(Model?.PrevInward ?? 0)</p>
                            </div>
                            <div class="p-3 bg-gray-50 dark:bg-gray-800/50 rounded-lg border-r-4 border-red-500">
                                <p class="text-[10px] text-gray-500 font-bold">منصرف</p>
                                <p class="text-lg font-bold dark:text-white">@(Model?.PrevOutward ?? 0)</p>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <div class="p-3 bg-gray-50 dark:bg-gray-800/50 rounded-lg border-r-4 border-emerald-500">
                                <p class="text-[10px] text-gray-500 font-bold">محول منه</p>
                                <p class="text-lg font-bold dark:text-white">@(Model?.PrevTransFrom ?? 0)</p>
                            </div>
                            <div class="p-3 bg-gray-50 dark:bg-gray-800/50 rounded-lg border-r-4 border-red-500">
                                <p class="text-[10px] text-gray-500 font-bold">محول اليه</p>
                                <p class="text-lg font-bold dark:text-white">@(Model?.PrevTransTo ?? 0)</p>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <div class="p-3 bg-gray-50 dark:bg-gray-800/50 rounded-lg border-r-4 border-emerald-500">
                                <p class="text-[10px] text-gray-500 font-bold">مرتجع وارد</p>
                                <p class="text-lg font-bold dark:text-white">@(Model?.PrevReturnIn ?? 0)</p>
                            </div>
                            <div class="p-3 bg-gray-50 dark:bg-gray-800/50 rounded-lg border-r-4 border-red-500">
                                <p class="text-[10px] text-gray-500 font-bold">اصناف راكده</p>
                                <p class="text-lg font-bold dark:text-white">@(Model?.PrevStagnant ?? 0)</p>
                            </div>
                        </div>

                        <div class="mt-8 flex flex-col items-center justify-center text-center">
                            <p class="text-sm text-gray-500 mb-1">إجمالي الرصيد الحالي</p>
                            <p class="text-4xl font-black text-gray-900 dark:text-white">@(Model?.TotalStockBalance ?? 0)</p>
                            <div class="w-20 h-1 bg-blue-600 rounded-full mt-2"></div>
                        </div>
                    </div>

                    <div id="secondBalanceSection" class="space-y-4 hidden">
                        <div class="grid grid-cols-2 gap-3">
                            <div class="p-3 bg-gray-50 dark:bg-gray-800/50 rounded-lg border-r-4 border-emerald-500">
                                <p class="text-[10px] text-gray-500 font-bold">وارد (سابق)</p>
                                <p class="text-lg font-bold dark:text-white" id="secInward">0</p>
                            </div>
                            <div class="p-3 bg-gray-50 dark:bg-gray-800/50 rounded-lg border-r-4 border-red-500">
                                <p class="text-[10px] text-gray-500 font-bold">منصرف (سابق)</p>
                                <p class="text-lg font-bold dark:text-white" id="secOutward">0</p>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <div class="p-3 bg-gray-50 dark:bg-gray-800/50 rounded-lg border-r-4 border-emerald-500">
                                <p class="text-[10px] text-gray-500 font-bold">محول منه</p>
                                <p class="text-lg font-bold dark:text-white" id="secTransFrom">0</p>
                            </div>
                            <div class="p-3 bg-gray-50 dark:bg-gray-800/50 rounded-lg border-r-4 border-red-500">
                                <p class="text-[10px] text-gray-500 font-bold">محول اليه</p>
                                <p class="text-lg font-bold dark:text-white" id="secTransTo">0</p>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <div class="p-3 bg-gray-50 dark:bg-gray-800/50 rounded-lg border-r-4 border-emerald-500">
                                <p class="text-[10px] text-gray-500 font-bold">مرتجع وارد</p>
                                <p class="text-lg font-bold dark:text-white" id="secReturnIn">0</p>
                            </div>
                            <div class="p-3 bg-gray-50 dark:bg-gray-800/50 rounded-lg border-r-4 border-red-500">
                                <p class="text-[10px] text-gray-500 font-bold">اصناف راكده</p>
                                <p class="text-lg font-bold dark:text-white" id="secStagnant">0</p>
                            </div>
                        </div>

                        <div class="mt-8 flex flex-col items-center justify-center text-center">
                            <p class="text-sm text-gray-500 mb-1">إجمالي الرصيد (تاريخ سابق)</p>
                            <p class="text-4xl font-black text-gray-900 dark:text-white" id="secBalance">0</p>
                            <div class="w-20 h-1 bg-blue-600 rounded-full mt-2"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>

@section Scripts {
    <script>
        $(document).ready(function() {
            $('#itemSelect').select2({
                placeholder: "اختر الصنف...",
                allowClear: true,
                width: '100%',
                dir: "rtl"
            });

            $('#btnShowBalance').on('click', function() {
                var itemCode = $('#itemSelect').val();
                if (!itemCode) {
                    _AlertHelper.showWarning("يجب اختيار صنف أولاً");
                    return;
                }

                $.ajax({
                    url: '@Url.Action("GetItemBalance", "ItemBalance")',
                    type: 'GET',
                    data: { itemCode: itemCode },
                    success: function(response) {
                        if (response.success) {
                            var data = response.data;
                            $('#selectedItemName').text('رصيد الصنف: ' + itemCode);
                            $('#balOpeningBalance').text(data.openingBalance || 0);
                            $('#balTotalStockBalance').text(data.totalStockBalance || 0);
                            $('#balTodayInward').text(data.todayInward || 0);
                            $('#balTodayOutward').text(data.todayOutward || 0);
                            $('#balTodayTransFrom').text(data.todayTransFrom || 0);
                            $('#balTodayTransTo').text(data.todayTransTo || 0);
                            $('#balTodayReturnIn').text(data.todayReturnIn || 0);
                            $('#balTodayReturnOut').text(data.todayReturnOut || 0);
                            $('#itemBalanceResult').removeClass('hidden').hide().fadeIn(300);

                            // Increment Today's Movement section values
                            $('#todayInward').text(parseFloat($('#todayInward').text()) + (data.todayInward || 0));
                            $('#todayOutward').text(parseFloat($('#todayOutward').text()) + (data.todayOutward || 0));
                            $('#todayTransFrom').text(parseFloat($('#todayTransFrom').text()) + (data.todayTransFrom || 0));
                            $('#todayTransTo').text(parseFloat($('#todayTransTo').text()) + (data.todayTransTo || 0));
                            $('#todayReturnIn').text(parseFloat($('#todayReturnIn').text()) + (data.todayReturnIn || 0));
                            $('#todayReturnOut').text(parseFloat($('#todayReturnOut').text()) + (data.todayReturnOut || 0));
                            $('#todayStagnant').text(parseFloat($('#todayStagnant').text()) + (data.todayStagnant || 0));
                            $('#todayBalance').text(parseFloat($('#todayBalance').text()) + (data.todayBalance || 0));

                            // Update Second* fields and toggle sections
                            $('#secInward').text(data.secondInward || 0);
                            $('#secOutward').text(data.secondOutward || 0);
                            $('#secTransFrom').text(data.secondTransFrom || 0);
                            $('#secTransTo').text(data.secondTransTo || 0);
                            $('#secReturnIn').text(data.secondReturnIn || 0);
                            $('#secStagnant').text(data.secondStagnant || 0);
                            $('#secBalance').text(data.secondBalance || 0);

                            // Hide Prev section, show Second section
                            $('#prevBalanceSection').addClass('hidden');
                            $('#secondBalanceSection').removeClass('hidden');
                        } else {
                            _AlertHelper.showWarning(response.message);
                            $('#itemBalanceResult').addClass('hidden');
                        }
                    },
                    error: function() {
                        _AlertHelper.showError("حدث خطأ أثناء جلب البيانات");
                    }
                });
            });

            $('#itemSelect').on('change', function() {
                if ($(this).val()) {
                    $('#btnShowBalance').click();
                }
            });
        });
    </script>
}