@model List<Application.Interfaces.Models.ItemDto>

@{
    ViewData["Title"] = "إدارة الأصناف";
}

<div class="max-w-7xl w-full mx-auto py-8" dir="rtl">
    <div class="flex flex-col lg:flex-row gap-6 mb-8 items-start lg:items-center justify-between">
        <div>
            <h1 class="text-2xl font-bold text-slate-900 dark:text-white">أكواد الأصناف</h1>
            <p class="text-sm text-slate-500 dark:text-slate-400 mt-1">إدارة وتعريف بيانات الأصناف ونقاط إعادة الطلب</p>
        </div>
        <div class="flex gap-3 w-full lg:w-auto">
            <button onclick="openModalForCreate()" class="flex-1 lg:flex-none flex items-center justify-center gap-2 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors shadow-md shadow-blue-500/20">
                <span class="material-icons-outlined text-sm">add</span>
                <span>إضافة صنف جديد</span>
            </button>
        </div>
    </div>

    <div class="flex items-center gap-4 flex-grow">
        <div class="relative max-w-xs w-full">
            <span class="absolute inset-y-0 right-0 pr-3 flex items-center text-slate-400">
                <span class="material-icons-outlined text-sm">search</span>
            </span>
            <input type="text" id="tableSearch"
                   class="w-full pr-10 py-2 bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 transition-all"
                   placeholder="بحث باسم الصنف أو الكود...">
        </div>

        <div class="relative max-w-xs w-full">
            <select id="categoryFilter"
                    class="w-full pr-7 pl-10 py-2 bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 appearance-none cursor-pointer">
                <option value="">كل التصنيفات</option>
                @foreach (var cat in ViewBag.Categories)
                {
                    <option value="@cat.CatgryDesc">@cat.CatgryDesc</option>
                }
            </select>

            <span class="material-icons-outlined absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 pointer-events-none text-base">
                expand_more
            </span>
        </div>
    </div>
</div>
<div class="bg-white dark:bg-[#1E293B] rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 overflow-hidden">
    <div class="overflow-x-auto">
        <table class="w-full text-right text-sm">
            <thead class="bg-slate-50 dark:bg-slate-800 border-b">
                <tr>
                    <th class="px-6 py-4 text-center">إجراءات</th>
                    <th class="px-6 py-4 text-center">الباركود</th>
                    <th class="px-6 py-4 text-center">الكمية</th>
                    <th class="px-6 py-4 text-center">إعادة الطلب</th>
                    <th class="px-6 py-4">التصنيف</th>
                    <th class="px-6 py-4">اسم الصنف</th>
                    <th class="px-6 py-4 text-center w-24">الكود</th>
                </tr>
            </thead>
            <tbody id="tableBodyContent">
            </tbody>
        </table>
        <div class="px-6 py-4 bg-slate-50 border-t flex items-center justify-between">
            <div class="text-sm text-slate-500">
                عرض <span id="showingCount">0</span> من أصل <span id="totalCount">0</span> صنف
            </div>
            <div class="flex gap-2" id="paginationButtons"></div>
        </div>
    </div>
</div>

<div id="itemModal" class="fixed inset-0 z-50 hidden overflow-y-auto">
    <div class="fixed inset-0 bg-black/50 transition-opacity" onclick="toggleModal('itemModal')"></div>
    <div class="flex min-h-full items-center justify-center p-4">
        <div class="relative bg-white dark:bg-slate-800 w-full max-w-2xl rounded-xl shadow-2xl p-6 text-right">
            <h2 class="text-xl font-bold mb-6 text-slate-900 dark:text-white border-b pb-3">إضافة صنف جديد</h2>

            <form id="addItemForm" class="space-y-4">
                <input type="hidden" name="ItemCode" id="hiddenItemCode">
                <input type="hidden" name="OldCatgryCode" id="OldCatgryCode">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium mb-1">التصنيف</label>
                        <select name="CatgryCode" required class="w-full px-3 py-2 border rounded-lg dark:bg-slate-900 dark:border-slate-700">
                            <option value="">اختر التصنيف...</option>
                            @foreach (var cat in ViewBag.Categories)
                            {
                                <option value="@cat.CatgryCode">@cat.CatgryDesc</option>
                            }
                        </select>
                    </div>

                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium mb-1">اسم الصنف</label>
                        <input type="text" name="ItemDesc" required class="w-full px-3 py-2 border rounded-lg dark:bg-slate-900 dark:border-slate-700">
                    </div>
@* 
                    <div>
                        <label class="block text-sm font-medium mb-1">الباركود</label>
                        <input type="text" name="Barecode" class="w-full px-3 py-2 border rounded-lg dark:bg-slate-900 dark:border-slate-700">
                    </div> *@
                </div>

                <div class="flex justify-end gap-3 mt-6 pt-4 border-t">
                    <button type="button" onclick="toggleModal('itemModal')" class="px-4 py-2 text-slate-600 bg-slate-100 rounded-lg hover:bg-slate-200 transition-colors">إلغاء</button>
                    <button type="submit" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 shadow-lg shadow-blue-500/30 transition-all flex items-center gap-2">
                        <span id="btnText">حفظ الصنف</span>
                        <div id="btnSpinner" class="hidden w-4 h-4 border-2 border-white/30 border-t-white rounded-full animate-spin"></div>
                    </button>
                </div>
            </form>

            <button onclick="toggleModal('itemModal')" class="absolute top-4 left-4 text-slate-400 hover:text-slate-600">
                <span class="material-icons-outlined">close</span>
            </button>
        </div>
    </div>
</div>
@section Scripts {
    <script>
        // المتغيرات العامة للتحكم في الصفحة
        let currentPage = 1;

        $(document).ready(function () {
            // التحميل الأولي للبيانات عند فتح الصفحة
            loadTable(1);

            // إعداد البحث والفلترة مع تأخير بسيط (Debounce) لتحسين الأداء
               let searchTimer;
        $('#tableSearch').on('keyup', function () {
            clearTimeout(searchTimer);
            searchTimer = setTimeout(() => {
                console.log("Searching for:", $(this).val()); // للتأكد في Console المتصفح
                loadTable(1); // استدعاء السيرفر لجلب نتائج البحث
            }, 500); // انتظر نصف ثانية بعد توقف المستخدم عن الكتابة
        });

        // الفلترة بالتصنيف
        $('#categoryFilter').on('change', function () {
            loadTable(1);
        });
            // معالج إرسال نموذج (إضافة/تعديل)
            $('#addItemForm').on('submit', function (e) {
                e.preventDefault();
                handleFormSubmit();
            });
        });

        // --- وظيفة جلب البيانات من السيرفر ---
        function loadTable(page) {
            currentPage = page;
            const searchText = $('#tableSearch').val();
            const categoryDesc = $('#categoryFilter').val();

            // إظهار حالة تحميل بسيطة (شفافية الجدول)
            $('#tableBodyContent').css('opacity', '0.5');

            $.ajax({
                url: '@Url.Action("GetItemsTable", "MainItems")',
                type: 'GET',
                data: {
                    page: page,
                    search: searchText,
                    category: categoryDesc
                },
                success: function (htmlContent) {
                    // حقن كود HTML الخاص بالصفوف داخل tbody
                    $('#tableBodyContent').html(htmlContent).css('opacity', '1');

                    // تحديث العدادات من الحقول المخفية التي أرسلها السيرفر في الـ Partial
                    const totalCount = $('#hdnTotalCount').val() || 0;
                    const totalPages = $('#hdnTotalPages').val() || 0;
                    const itemsOnPage = $('#tableBodyContent tr.item-row').length;

                    $('#totalCount').text(totalCount);
                    $('#showingCount').text(itemsOnPage === 0 ? 0 : itemsOnPage);

                    // إعادة رسم أزرار الترقيم
                    renderPaginationButtons(parseInt(totalPages), parseInt(page));
                },
                error: function () {
                    $('#tableBodyContent').css('opacity', '1').html('<tr><td colspan="7" class="text-center py-8 text-red-500">فشل تحميل البيانات، يرجى المحاولة لاحقاً</td></tr>');
                }
            });
        }

        // --- إدارة أزرار الترقيم (Pagination UI) ---
        function renderPaginationButtons(totalPages, current) {
            const $container = $('#paginationButtons').empty();
            if (totalPages <= 1) return;

            // زر السابق
            if (current > 1) {
                appendPaginationBtn('chevron_right', current - 1);
            }

            // عرض الأرقام بتصميم ذكي (أول صفحة، آخر صفحة، والصفحات حول الحالية)
            for (let i = 1; i <= totalPages; i++) {
                if (i === 1 || i === totalPages || (i >= current - 1 && i <= current + 1)) {
                    appendPaginationBtn(i, i, i === current);
                } else if (i === current - 2 || i === current + 2) {
                    $container.append('<span class="text-slate-400 px-1">...</span>');
                }
            }

            // زر التالي
            if (current < totalPages) {
                appendPaginationBtn('chevron_left', current + 1);
            }
        }

        function appendPaginationBtn(text, page, isActive) {
            const isIcon = isNaN(text);
            const content = isIcon ? `<span class="material-icons-outlined text-sm leading-none">${text}</span>` : text;
            const activeClass = isActive
                ? "bg-blue-600 text-white border-blue-600"
                : "bg-white dark:bg-slate-900 text-slate-600 hover:bg-blue-50 border-slate-200 dark:border-slate-700";

            $(`<button class="flex items-center justify-center px-3 py-1.5 rounded-lg border text-xs font-bold transition-all min-w-[32px] ${activeClass}">${content}</button>`)
                .on('click', function() {
                    loadTable(page);
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                }).appendTo('#paginationButtons');
        }

        // --- وظائف المودال (إضافة/تعديل) ---
        function openModalForCreate() {
            const $form = $('#addItemForm');
            $form[0].reset();
            $form.attr('data-mode', 'create');
            $('#itemModal h2').text('إضافة صنف جديد');
            $('#btnText').text('حفظ الصنف');
            toggleModal('itemModal');
        }

        window.editItem = function(btn) {
            const $row = $(btn).closest('tr');
            const $form = $('#addItemForm');

            const data = {
                code: $row.attr('data-code'),
                name: $row.attr('data-name'),
                catId: $row.attr('data-catid'),
                barcode: $row.attr('data-barcode')
            };

            $form.attr('data-mode', 'edit');
            $('#itemModal h2').text('تعديل صنف: ' + data.code);
            $('#btnText').text('تحديث البيانات');
            $('#OldCatgryCode').val(data.catId);

            $form.find('input[name="ItemCode"]').val(data.code);
            $form.find('input[name="ItemDesc"]').val(data.name);
            $form.find('select[name="CatgryCode"]').val(data.catId);

            toggleModal('itemModal');
        };

        function handleFormSubmit() {
            const $form = $('#addItemForm');
            const mode = $form.attr('data-mode');
            const url = mode === 'edit' ? '@Url.Action("Update", "MainItems")' : '@Url.Action("CreateItem", "MainItems")';

            const $btn = $form.find('button[type="submit"]');
            $btn.prop('disabled', true).find('#btnText').text('جاري المعالجة...');
            $('#btnSpinner').removeClass('hidden');

            $.ajax({
                url: url,
                type: 'POST',
                data: $form.serialize(),
                success: function (response) {
                    if (response.success) {
                        _AlertHelper.showSuccess(response.message || "تمت العملية بنجاح").then(() => {
                            toggleModal('itemModal');
                            loadTable(currentPage); 
                        });
                    } else {
                        _AlertHelper.showError(response.message || "حدث خطأ");
                    }
                },
                complete: function () {
                    $btn.prop('disabled', false).find('#btnText').text(mode === 'edit' ? 'تحديث البيانات' : 'حفظ الصنف');
                    $('#btnSpinner').addClass('hidden');
                }
            });
        }

        window.deleteItem = function(itemCode) {
            _AlertHelper.showConfirm("حذف صنف", `هل أنت متأكد من حذف الصنف (${itemCode})؟`, "نعم، احذف")
            .then((result) => {
                if (result.isConfirmed) {
                    $.ajax({
                        url: '@Url.Action("DeleteItem", "MainItems")',
                        type: 'POST',
                        data: { id: itemCode },
                        success: function (response) {
                            if (response.success) {
                                _AlertHelper.showSuccess("تم الحذف").then(() => loadTable(currentPage));
                            } else {
                                _AlertHelper.showError(response.message);
                            }
                        }
                    });
                }
            });
        };

        function toggleModal(id) {
            $(`#${id}`).toggleClass('hidden');
        }
    </script>
}